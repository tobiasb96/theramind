<!-- Session Notes Card with Workflow -->

{% if update_generation_status %}

  <div hx-get="?update_generation_status=true"
       hx-trigger="every 5s"
       hx-swap="outerHTML">

    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Sitzungsnotizen</h2>
      </div>
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
        <svg class="w-3 h-3 mr-1 text-yellow-500 animate-spin"
             viewBox="0 0 24 24"
             fill="none">
          <circle class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
          <path class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        Notizen werden generiert
      </span>
          <span class="ml-4 text-yellow-700 text-sm mx-2">Die KI erstellt gerade die Sitzungsnotizen. Bitte warte einen Moment.</span>
        </div>
      </div>
    </div>

  </div>

{% else %}

  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-lg font-semibold text-gray-900">Sitzungsnotizen</h2>
      {% if session.notes %}
        <div class="flex space-x-2">
          {% if session.all_inputs.total_count > 0 %}
            <button data-modal-target="ai-notes-modal"
                    data-modal-toggle="ai-notes-modal"
                    type="button"
                    class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="currentColor"
                   viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                      clip-rule="evenodd"></path>
              </svg>
              Aus Material regenerieren
            </button>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {% if not session.notes %}
      {% if session.all_inputs.total_count == 0 %}
        <!-- Step 1: No inputs - Initial workflow selection -->
        <div class="mb-8">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 mr-2 bg-blue-600 rounded-full flex items-center justify-center">
                  <span class="text-white font-medium text-sm">1</span>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="text-lg font-medium text-blue-900">Wähle Deinen Workflow</h3>
                <p class="text-blue-700 text-sm mt-1">Wie möchtest Du die Sitzungsnotizen erstellen?</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button data-modal-target="audio-input-modal"
                    data-modal-toggle="audio-input-modal"
                    class="flex flex-col items-center p-6 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
              <svg class="w-8 h-8 text-blue-600 mb-3"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
              </svg>
              <h4 class="text-sm font-medium text-blue-900">Aufnahme hinzufügen</h4>
              <p class="text-xs text-blue-700 mt-1 text-center">Audio aufnehmen oder hochladen</p>
            </button>
            <button data-modal-target="document-input-modal"
                    data-modal-toggle="document-input-modal"
                    class="flex flex-col items-center p-6 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
              <svg class="w-8 h-8 text-green-600 mb-3"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <h4 class="text-sm font-medium text-green-900">Notizen hinzufügen</h4>
              <p class="text-xs text-green-700 mt-1 text-center">Dokumente hochladen oder Text eingeben</p>
            </button>
            <button data-modal-target="template-selection-modal"
                    data-modal-toggle="template-selection-modal"
                    class="flex flex-col items-center p-6 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors">
              <svg class="w-8 h-8 text-purple-600 mb-3"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              <h4 class="text-sm font-medium text-purple-900">Mit Vorlage starten</h4>
              <p class="text-xs text-purple-700 mt-1 text-center">Vorlage auswählen und direkt bearbeiten</p>
            </button>
          </div>
        </div>
      {% else %}
        <!-- Step 2: Has inputs - Show generate notes option -->
        {% if not any_inputs_processing %}
          {% if session.all_processed_inputs.audio_count > 0 or session.all_processed_inputs.document_count > 0 %}
            <div class="mb-8">
              {% include "partials/material_session_ready.html" %}

              <div class="flex justify-center mt-6">
                <div class="text-center">
                  <p class="text-sm text-gray-600 mb-4">Oder wähle eine andere Option:</p>
                  <div class="flex space-x-4">
                    <button data-modal-target="template-selection-modal"
                            data-modal-toggle="template-selection-modal"
                            type="button"
                            class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center">
                      <svg class="w-4 h-4 mr-2"
                           fill="none"
                           stroke="currentColor"
                           viewBox="0 0 24 24">
                        <path stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                      </svg>
                      Mit Vorlage starten
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% else %}
          <!-- Step 2b: Has inputs but not processed yet -->
          <div class="mb-8">
            {% include "partials/material_session_not_ready.html" %}

            <div class="text-center">
              <p class="text-sm text-gray-600 mb-4">Oder starte bereits mit einer Vorlage:</p>
              <button data-modal-target="template-selection-modal"
                      data-modal-toggle="template-selection-modal"
                      type="button"
                      class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center">
                <svg class="w-4 h-4 mr-2"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Manuell mit Vorlage starten
              </button>
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% else %}
      <!-- Session Notes Editor when notes exist -->
      <form id="session-notes-form"
            method="post"
            action="{% url 'sessions:session_save_notes' pk=session.pk %}"
            hx-post="{% url 'sessions:session_save_notes' pk=session.pk %}"
            hx-target="#autosave-response"
            hx-swap="innerHTML">
        {% csrf_token %}
        <div class="mb-4">
          {% include 'partials/wysiwyg_editor.html' with editor_id='session-notes-editor' input_name='session_notes' content=session.notes label='Sitzungsnotizen' placeholder='Sitzungsnotizen werden hier angezeigt und können bearbeitet werden...' min_height='400px' %}
        </div>
      </form>

      <!-- Auto-save indicator -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center">
          <div id="autosave-response"></div>
        </div>

        <!-- Copy and Export buttons -->
        <div class="flex items-center space-x-2">
          <button type="button"
                  id="copy-notes-btn"
                  class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-2 text-center inline-flex items-center">
            <svg class="w-4 h-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Kopieren
          </button>

          <form method="post"
                action="{% url 'sessions:session_export_notes_pdf' pk=session.pk %}"
                class="inline">
            {% csrf_token %}
            <button type="submit"
                    class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-2 text-center inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              PDF exportieren
            </button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Hidden content for session notes -->
  <div id="session-notes-content-hidden"
       style="display: none;">
    {{ session.notes|safe }}
  </div>

{% endif %}