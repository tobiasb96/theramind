{% extends 'base.html' %}
{% load static %}

{% block title %}{{ report.title }} - Berichte{% endblock %}

{% block content %}
  <div class="mx-auto">

    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">{{ report.title }}</h1>
          <div class="mt-3 space-y-2">
            <div class="flex items-center text-gray-600">
              <svg class="w-4 h-4 mr-2"
                   aria-hidden="true"
                   xmlns="http://www.w3.org/2000/svg"
                   fill="none"
                   viewBox="0 0 24 24">
                <path stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 10h16m-8-3V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Zm3-7h.01v.01H8V13Zm4 0h.01v.01H12V13Zm4 0h.01v.01H16V13Zm-8 4h.01v.01H8V17Zm4 0h.01v.01H12V17Zm4 0h.01v.01H16V17Z"/>
              </svg>
              <span>Erstellt: {{ report.created_at|date:"d.m.Y H:i" }}</span>
            </div>
            {% if report.patient_gender != 'not_specified' %}
              <div class="flex items-center text-gray-600">
                <svg class="w-4 h-4 mr-2"
                     aria-hidden="true"
                     xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24">
                  <path stroke="currentColor"
                        stroke-width="2"
                        d="M7 17v1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1a3 3 0 0 0-3-3h-4a3 3 0 0 0-3 3Zm8-9a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                </svg>
                <span>{{ report.get_patient_gender_display }}</span>
              </div>
            {% endif %}
            {% if report.updated_at != report.created_at %}
              <div class="flex items-center text-gray-500 text-sm">
                <svg class="w-4 h-4 mr-2"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span>Aktualisiert: {{ report.updated_at|date:"d.m.Y H:i" }}</span>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="flex space-x-2">
          <button id="report-actions-dropdown"
                  data-dropdown-toggle="report-actions-menu"
                  class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-2 text-center inline-flex items-center"
                  type="button">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="2"
                 stroke="currentColor"
                 class="w-5 h-5">
              <path stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/>
            </svg>
          </button>

          <!-- Dropdown menu -->
          <div id="report-actions-menu"
               class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44">
            <ul class="py-2 text-sm text-gray-700"
                aria-labelledby="report-actions-dropdown">
              <li>
                <button data-modal-target="edit-modal"
                        data-modal-toggle="edit-modal"
                        class="flex items-center text-blue-700 px-4 py-2 hover:bg-gray-100 w-full text-left cursor-pointer">
                  <svg class="mr-2 w-4 h-4"
                       aria-hidden="true"
                       xmlns="http://www.w3.org/2000/svg"
                       width="24"
                       height="24"
                       fill="none"
                       viewBox="0 0 24 24">
                    <path stroke="currentColor"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  Bearbeiten
                </button>
              </li>

              <li>
                <button data-modal-target="delete-modal"
                        data-modal-toggle="delete-modal"
                        class="flex items-center text-red-700 px-4 py-2 hover:bg-gray-100 w-full text-left cursor-pointer">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       fill="none"
                       viewBox="0 0 24 24"
                       stroke-width="2"
                       stroke="currentColor"
                       class="mr-2 w-4 h-4">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                  </svg>
                  Löschen
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Background Audio Recording Indicators -->
    <div id="background-recording-indicators"
         class="mb-6 space-y-3">
      <!-- Unsaved Recording Indicator -->
      <div id="unsaved-recording-indicator"
           class="hidden bg-amber-50 border border-amber-200 rounded-lg p-4">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="w-5 h-5 text-amber-600 mr-3"
                 fill="currentColor"
                 viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-amber-900">Ungespeicherte Aufnahme vorhanden</h3>
                <p class="text-amber-700 text-sm">Sie haben eine ungespeicherte Audioaufnahme
                  (<span id="unsaved-recording-duration"
                         class="font-mono">00:00</span>)</p>
              </div>
              <div class="flex space-x-2">
                <button data-modal-target="audio-input-modal"
                        data-modal-toggle="audio-input-modal"
                        class="text-amber-700 bg-amber-100 hover:bg-amber-200 focus:ring-4 focus:outline-none focus:ring-amber-300 font-medium rounded-lg text-sm px-3 py-2 text-center inline-flex items-center">
                  <svg class="w-4 h-4 mr-1"
                       fill="none"
                       stroke="currentColor"
                       viewBox="0 0 24 24">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  Fortsetzen
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Processing Indicator -->
      <div id="processing-indicator"
           class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="w-5 h-5 text-blue-600 mr-3 animate-spin"
                 fill="none"
                 viewBox="0 0 24 24">
              <circle class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"></circle>
              <path class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-medium text-blue-900">Audio wird verarbeitet</h3>
            <p class="text-blue-700 text-sm">Transkription läuft im Hintergrund...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Unified Multimodal Input Section - Only show when inputs exist -->
    {% if report.all_inputs.total_count > 0 %}
      {% with document_type='report' audio_inputs=report.audio_inputs.all document_inputs=report.document_inputs.all document=report %}
        {% include 'partials/multimodal_input_widget.html' %}
      {% endwith %}
    {% endif %}

    <!-- Report Content Section with Workflow -->
    {% include "partials/report_card.html" %}

  </div>

  <!-- Edit Report Modal -->
  <div id="edit-modal"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <!-- Modal content -->
      <div class="relative bg-white rounded-lg shadow">
        <!-- Modal header -->
        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            Bericht bearbeiten
          </h3>
          <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                  data-modal-toggle="edit-modal">
            <svg class="w-3 h-3"
                 aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 14 14">
              <path stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <!-- Modal body -->
        <form class="p-4 md:p-5"
              method="post"
              action="{% url 'reports:report_edit' pk=report.pk %}">
          {% csrf_token %}
          <div class="grid gap-4 mb-4">
            <div class="col-span-2">
              <label for="edit-title"
                     class="block mb-2 text-sm font-medium text-gray-900">Titel</label>
              <input type="text"
                     name="title"
                     id="edit-title"
                     value="{{ report.title }}"
                     class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                     placeholder="Berichttitel"
                     required>
            </div>
            <div class="col-span-2">
              <label for="edit-report-patient-gender"
                     class="block mb-2 text-sm font-medium text-gray-900">Patient: Geschlecht</label>
              <select id="edit-report-patient-gender"
                      name="patient_gender"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                      required>
                <option value="not_specified"
                        {% if report.patient_gender == 'not_specified' %}selected{% endif %}>Nicht angegeben
                </option>
                <option value="male"
                        {% if report.patient_gender == 'male' %}selected{% endif %}>Männlich
                </option>
                <option value="female"
                        {% if report.patient_gender == 'female' %}selected{% endif %}>Weiblich
                </option>
                <option value="diverse"
                        {% if report.patient_gender == 'diverse' %}selected{% endif %}>Divers
                </option>
              </select>
            </div>
          </div>
          <button type="submit"
                  class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
            <svg class="me-1 -ms-1 w-5 h-5"
                 fill="currentColor"
                 viewBox="0 0 20 20"
                 xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd"
                    d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                    clip-rule="evenodd"></path>
            </svg>
            Bericht aktualisieren
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Report Modal -->
  <div id="delete-modal"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <!-- Modal content -->
      <div class="relative p-4 text-center bg-white rounded-lg shadow sm:p-5">
        <button type="button"
                class="text-gray-400 absolute top-2.5 right-2.5 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"
                data-modal-toggle="delete-modal">
          <svg aria-hidden="true"
               class="w-5 h-5"
               fill="currentColor"
               viewBox="0 0 20 20"
               xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"></path>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
        <svg class="text-gray-400 w-6 h-6 mb-3.5 mx-auto"
             aria-hidden="true"
             fill="currentColor"
             viewBox="0 0 20 20"
             xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd"
                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                clip-rule="evenodd"></path>
        </svg>
        <p class="mb-4 text-gray-500">Bist Du sicher, dass Du diesen Bericht löschen möchtest?</p>
        <div class="flex justify-center items-center space-x-4">
          <button data-modal-toggle="delete-modal"
                  type="button"
                  class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center">
            <svg class="w-4 h-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Nein, abbrechen
          </button>
          <form method="post"
                action="{% url 'reports:report_delete' pk=report.pk %}"
                class="inline">
            {% csrf_token %}
            <button type="submit"
                    class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Ja, löschen
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- File Upload Modal -->
  <div id="file-upload-modal"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Datei hochladen</h3>
          <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                  data-modal-toggle="file-upload-modal">
            <svg class="w-3 h-3"
                 aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 14 14">
              <path stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <form class="p-4 md:p-5"
              method="post"
              enctype="multipart/form-data"
              action="{% url 'core:add_document_file_input' document_type='report' document_id=report.pk %}">
          {% csrf_token %}
          <div class="mb-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3"
                     fill="currentColor"
                     viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                        clip-rule="evenodd"/>
                </svg>
                <div class="text-sm">
                  <p class="font-medium text-blue-900">Datei wird automatisch verarbeitet</p>
                  <p class="text-blue-700 mt-1">Text wird aus der Datei extrahiert und für die KI-Berichtgenerierung
                    verwendet.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Datei auswählen
            </label>
            <input type="file"
                   name="original_file"
                   accept=".pdf,.docx,.doc,.txt"
                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                   required>
            <p class="text-xs text-gray-500 mt-1">Unterstützte Formate: PDF, Word (.docx, .doc), Text (.txt)</p>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button"
                    class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center"
                    data-modal-toggle="file-upload-modal">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Abbrechen
            </button>
            <button type="submit"
                    class="px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Hochladen
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Text Input Modal -->
  <div id="text-input-modal"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-4xl max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Text eingeben</h3>
          <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                  data-modal-toggle="text-input-modal">
            <svg class="w-3 h-3"
                 aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 14 14">
              <path stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <form class="p-4 md:p-5"
              method="post"
              action="{% url 'core:add_document_text_input' document_type='report' document_id=report.pk %}">
          {% csrf_token %}
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Bezeichnung
            </label>
            <input type="text"
                   name="file_name"
                   placeholder="z.B. Notizen vom 15.01.2024"
                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                   required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Text
            </label>
            <textarea name="text_input"
                      rows="15"
                      placeholder="Gib hier den Text ein, der als Kontext für den Bericht verwendet werden soll..."
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                      required></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button"
                    class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center"
                    data-modal-toggle="text-input-modal">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Abbrechen
            </button>
            <button type="submit"
                    class="px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Hinzufügen
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Template Selection Modal -->
  <div id="template-selection-modal"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            Vorlage auswählen
          </h3>
          <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                  data-modal-toggle="template-selection-modal">
            <svg class="w-3 h-3"
                 aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 14 14">
              <path stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <form id="template-selection-form"
              class="p-4 md:p-5"
              method="post"
              action="{% url 'reports:report_create_from_template' pk=report.pk %}">
          {% csrf_token %}
          <div class="mb-4">
            <label for="template-select-manual"
                   class="block mb-2 text-sm font-medium text-gray-900">Vorlage auswählen</label>
            <select id="template-select-manual"
                    name="template"
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                    required>
              <option value="">Bitte wähle eine Vorlage</option>
              {% for template in report_templates %}
                <option value="{{ template.id }}">{{ template.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3"
                     fill="currentColor"
                     viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                        clip-rule="evenodd"/>
                </svg>
                <div class="text-sm">
                  <p class="font-medium text-blue-900">Optional: Material hinzufügen</p>
                  <p class="text-blue-700 mt-1">Du kannst nach der Vorlagenauswahl noch Audio oder Dokumente hinzufügen,
                    um KI-generierte Berichte zu erstellen.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-2">
            <button type="button"
                    data-modal-toggle="template-selection-modal"
                    class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Abbrechen
            </button>
            <button type="submit"
                    class="px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 inline-flex items-center">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Vorlage verwenden
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Report Generation Modal -->
  <div id="report-generation-modal"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <div class="relative bg-white rounded-lg shadow">
        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Bericht generieren</h3>
          <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                  data-modal-toggle="report-generation-modal">
            <svg class="w-3 h-3"
                 aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 14 14">
              <path stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <div class="p-4 md:p-5">
          <div class="mb-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3"
                     fill="currentColor"
                     viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                        clip-rule="evenodd"/>
                </svg>
                <div class="text-sm">
                  <p class="font-medium text-blue-900">Alle verfügbaren Eingaben werden kombiniert</p>
                  <p class="text-blue-700 mt-1">Die KI erstellt einen strukturierten Bericht basierend auf
                    Audio-Transkriptionen und Dokumenten.</p>
                  <div class="mt-2 text-xs text-blue-600">
                    <span class="font-medium">{{ report.all_inputs.audio_count }} Audio</span> +
                    <span class="font-medium">{{ report.all_inputs.document_count }} Dokumente</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-4">
            <label for="template-select"
                   class="block mb-2 text-sm font-medium text-gray-900">Report-Vorlage auswählen</label>
            <select id="template-select"
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                    required>
              <option value="">Bitte wähle eine Vorlage</option>
              {% for template in report_templates %}
                <option value="{{ template.id }}">{{ template.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div id="generation-status"
               class="mb-4 hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600"
                     xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 24 24">
                  <circle class="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          stroke-width="4"></circle>
                  <path class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm text-blue-600">Bericht wird generiert...</span>
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button"
                    class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center"
                    data-modal-toggle="report-generation-modal">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Abbrechen
            </button>
            <button type="button"
                    id="generate-report-btn"
                    class="px-4 py-2.5 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 inline-flex items-center"
                    onclick="generateReport()">
              <svg class="w-4 h-4 mr-2"
                   fill="currentColor"
                   viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                      clip-rule="evenodd"></path>
              </svg>
              Generieren
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Toggle context preview
    function toggleContextPreview(contextFileId) {
      const preview = document.getElementById(`context-preview-${contextFileId}`);
      preview.classList.toggle('hidden');
    }

    function deleteContextFile(contextFileId) {
      if (!confirm('Möchtest Du diese Kontext-Datei wirklich löschen?')) {
        return;
      }

      fetch(`{% url 'core:delete_document_input' 0 %}`.replace('0', contextFileId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          'context_file_id': contextFileId
        })
      })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Fehler beim Löschen: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Löschen der Datei');
          });
    }


    function generateReport() {
      const templateId = document.getElementById('template-select').value;
      if (!templateId) {
        alert('Bitte wähle eine Vorlage aus');
        return;
      }

      const statusDiv = document.getElementById('generation-status');
      const generateBtn = document.getElementById('generate-report-btn');

      statusDiv.classList.remove('hidden');
      generateBtn.disabled = true;

      fetch(`{% url 'reports:generate_content' report.pk %}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          'template_id': templateId
        })
      })
          .then(response => response.json())
          .then(data => {
            statusDiv.classList.add('hidden');
            generateBtn.disabled = false;

            if (data.success) {
              // Close modal using Flowbite method
              const modal = FlowbiteInstances.getInstance('Modal', 'report-generation-modal');
              if (modal) {
                modal.hide();
              }
              location.reload();
            } else {
              alert('Fehler bei der Generierung: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            statusDiv.classList.add('hidden');
            generateBtn.disabled = false;
            alert('Fehler bei der Berichtgenerierung');
          });
    }

    function saveContent() {
      if (!window.reportContentEditor) {
        return;
      }

      const content = window.reportContentEditor.getHTML();
      const saveBtn = document.getElementById('save-content-btn');

      if (!saveBtn) return;

      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = `
        <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Speichern...
    `;

      fetch(`{% url 'reports:save_content' report.pk %}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `content=${encodeURIComponent(content)}`
      })
          .then(response => {
            if (response.ok) {
              saveBtn.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Gesichert
            `;
              saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
              saveBtn.classList.add('bg-green-600');
              setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                saveBtn.classList.remove('bg-green-600');
                saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
              }, 2000);
            } else {
              throw new Error('Fehler beim Speichern');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            saveBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
            </svg>
            Fehler
        `;
            saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            saveBtn.classList.add('bg-red-600');
            saveBtn.disabled = false;
            setTimeout(() => {
              saveBtn.innerHTML = originalText;
              saveBtn.classList.remove('bg-red-600');
              saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 2000);
          });
    }

  </script>

  <script type="module"
          src="{% static 'js/wysiwyg_editor.js' %}">
  </script>

  <script>
    // Initialize WYSIWYG editor and extras on page load
    (function () {
      function init() {
        if (window.initWysiwygEditor) {
          window.initWysiwygEditor(
              'report-content-editor',
              `{{ report.content|safe|escapejs }}`,
              `{{ placeholder|default:'Text eingeben...'|escapejs }}`
          );
          window.initReportExtras();
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

  <script>
    // Reinitialize WYSIWYG editor and extras after HTMX swaps content
    // (initial page load init is handled in wysiwyg_editor.html template)
    document.body.addEventListener('htmx:afterSwap', function (evt) {
      const editorElement = document.getElementById('report-content-editor');
      if (editorElement && typeof window.initWysiwygEditor === 'function') {
        const contentElement = document.getElementById('report-content-hidden');
        let content = ``
        if (contentElement) {
          content = contentElement.innerHTML;
        }
        window.initWysiwygEditor('report-content-editor', content,
            `{{ placeholder|default:'Text eingeben...'|escapejs }}`);
      }
      if (editorElement && typeof window.initReportExtras === 'function') {
        window.initReportExtras();
      }
    });
  </script>

  <!-- Include Audio Input Modal -->
  {% with document_type='report' document=report %}
    {% include 'partials/audio_input_modal.html' %}
  {% endwith %}

  <!-- Include Document Input Modal -->
  {% with document_type='report' document=report %}
    {% include 'partials/document_input_modal.html' %}
  {% endwith %}

{% endblock %} 