<!-- Audio Workflow Modal -->
<div id="audio-workflow-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow-sm">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    Audio hinzufügen
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-toggle="audio-workflow-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <form id="audio-upload-form" class="p-4 md:p-5" method="post" enctype="multipart/form-data" action="{% url 'sessions:session_audio_upload' pk=session.pk %}">
                {% csrf_token %}
                <div class="mb-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div class="text-sm">
                                <p class="font-medium text-blue-900">Audio wird automatisch transkribiert</p>
                                <p class="text-blue-700 mt-1">Nach dem Upload kannst Du KI-Notizen aus der Transkription generieren lassen.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex mb-4 gap-2">
                    <button id="tab-record" type="button" class="flex-1 px-3 py-2 rounded-t-lg bg-blue-50 text-blue-700 font-medium">Aufnahme starten</button>
                    <button id="tab-upload" type="button" class="flex-1 px-3 py-2 rounded-t-lg bg-gray-50 text-gray-700 font-medium">Datei hochladen</button>
                </div>
                <div id="record-section">
                    <div class="flex flex-col items-center mb-4">
                        <button id="record-toggle" type="button" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center justify-center mb-2">
                            <svg id="record-icon" class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path id="record-icon-path" fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                            </svg>
                            <span id="record-text">Aufnahme starten</span>
                        </button>
                        <div id="recording-indicator" class="hidden mt-2 flex items-center justify-center">
                            <div class="flex items-center">
                                <div class="animate-pulse w-3 h-3 bg-red-600 rounded-full mr-2"></div>
                                <span id="recording-time" class="text-sm text-red-600 font-medium">00:00</span>
                            </div>
                        </div>
                        <div id="audio-preview" class="hidden mt-4 w-full">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-gray-900 mb-3">Aufnahme-Vorschau</h3>
                                <audio id="recorded-audio" controls class="w-full mb-3"></audio>
                            </div>
                        </div>
                        <input type="hidden" name="audio_recorded" id="audio-recorded-input">
                    </div>
                </div>
                <div id="upload-section" class="hidden mb-4">
                    <label class="block mb-2 text-sm font-medium text-gray-900" for="modal-audio-upload">Audio-Datei auswählen</label>
                    <input class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" id="modal-audio-upload" name="audio" type="file" accept="audio/*">
                    <p class="mt-1 text-sm text-gray-500">MP3, WAV, M4A oder FLAC (max. 25MB)</p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-blue-700 text-white px-5 py-2 rounded hover:bg-blue-800">Audio hinzufügen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Audio Recording Modal Logic
(function() {
    // Scoped variables to avoid global conflicts
    let modalMediaRecorder;
    let modalRecordedChunks = [];
    let recordingTimer;
    let recordingSeconds = 0;
    let isRecording = false;

    // DOM Elements
    const recordSection = document.getElementById('record-section');
    const uploadSection = document.getElementById('upload-section');
    const tabRecord = document.getElementById('tab-record');
    const tabUpload = document.getElementById('tab-upload');
    const recordToggle = document.getElementById('record-toggle');
    const recordText = document.getElementById('record-text');
    const recordIconPath = document.getElementById('record-icon-path');
    const recordingIndicator = document.getElementById('recording-indicator');
    const recordingTime = document.getElementById('recording-time');
    const audioPreview = document.getElementById('audio-preview');
    const recordedAudio = document.getElementById('recorded-audio');
    const audioUploadForm = document.getElementById('audio-upload-form');
    const modalAudioUpload = document.getElementById('modal-audio-upload');

    function resetRecordingUI() {
        recordText.textContent = 'Aufnahme starten';
        recordIconPath.setAttribute('d', 'M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z');
        recordToggle.className = 'w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center justify-center mb-2';
        recordingIndicator.classList.add('hidden');
        recordingTime.textContent = '00:00';
        audioPreview.classList.add('hidden');
        recordedAudio.src = '';
        modalRecordedChunks = [];
        recordingSeconds = 0;
        isRecording = false;
        if (modalMediaRecorder && modalMediaRecorder.state !== 'inactive') {
            modalMediaRecorder.stop();
        }
        if (recordingTimer) clearInterval(recordingTimer);
    }

    // Tab switching logic
    tabRecord.onclick = function() {
        recordSection.classList.remove('hidden');
        uploadSection.classList.add('hidden');
        this.classList.add('bg-blue-50', 'text-blue-700');
        this.classList.remove('bg-gray-50', 'text-gray-700');
        tabUpload.classList.remove('bg-blue-50', 'text-blue-700');
        tabUpload.classList.add('bg-gray-50', 'text-gray-700');
        resetRecordingUI();
    };

    tabUpload.onclick = function() {
        recordSection.classList.add('hidden');
        uploadSection.classList.remove('hidden');
        this.classList.add('bg-blue-50', 'text-blue-700');
        this.classList.remove('bg-gray-50', 'text-gray-700');
        tabRecord.classList.remove('bg-blue-50', 'text-blue-700');
        tabRecord.classList.add('bg-gray-50', 'text-gray-700');
        resetRecordingUI();
    };

    // Recording toggle logic
    recordToggle.onclick = async function() {
        if (!isRecording) {
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                modalMediaRecorder = new MediaRecorder(stream);
                modalRecordedChunks = [];
                isRecording = true;
                
                recordText.textContent = 'Aufnahme stoppen';
                recordIconPath.setAttribute('d', 'M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v6a1 1 0 11-2 0V7z');
                recordToggle.className = 'w-full text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center justify-center mb-2';
                recordingIndicator.classList.remove('hidden');
                
                recordingSeconds = 0;
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                
                modalMediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) modalRecordedChunks.push(event.data);
                };
                
                modalMediaRecorder.onstop = () => {
                    audioPreview.classList.remove('hidden');
                    const blob = new Blob(modalRecordedChunks, { type: 'audio/webm' });
                    recordedAudio.src = URL.createObjectURL(blob);
                };
                
                modalMediaRecorder.start();
            } catch (error) {
                alert('Fehler beim Zugriff auf das Mikrofon: ' + error.message);
                isRecording = false;
            }
        } else {
            // Stop recording
            if (modalMediaRecorder && modalMediaRecorder.state !== 'inactive') {
                modalMediaRecorder.stop();
                modalMediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            isRecording = false;
            recordText.textContent = 'Aufnahme starten';
            recordIconPath.setAttribute('d', 'M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z');
            recordToggle.className = 'w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center justify-center mb-2';
            recordingIndicator.classList.add('hidden');
            if (recordingTimer) clearInterval(recordingTimer);
        }
    };

    // Form submission logic
    audioUploadForm.onsubmit = function(e) {
        // For recorded audio, we need to set the blob as a file before submitting
        if (!recordSection.classList.contains('hidden')) {
            // We're in record mode
            if (modalRecordedChunks.length === 0) {
                e.preventDefault();
                alert('Bitte nimm zuerst etwas auf.');
                return;
            }
            
            // Create a file from the recorded blob and set it to the file input
            const blob = new Blob(modalRecordedChunks, { type: 'audio/webm' });
            const file = new File([blob], 'aufnahme.webm', { type: 'audio/webm' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            modalAudioUpload.files = dataTransfer.files;
        } else {
            // We're in upload mode, check if a file is selected
            if (!modalAudioUpload.files[0]) {
                e.preventDefault();
                alert('Bitte wähle eine Datei aus.');
                return;
            }
        }
        
        // Let the form submit naturally - no preventDefault()
    };

    // Reset UI when modal is closed
    document.addEventListener('click', function(e) {
        if (e.target.matches('[data-modal-toggle="audio-workflow-modal"]')) {
            // Small delay to ensure modal is fully closed before resetting
            setTimeout(resetRecordingUI, 300);
        }
    });

    // Initialize default tab state
    tabRecord.click();
})();
</script>
